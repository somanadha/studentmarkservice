version: 2.1

jobs:
  build-and-deploy:
    docker:
      - image: cimg/base:stable
    environment:
      APP_NAME: "studentmarkservice"
      APP_NAMESPACE: "studentmarkservice-ns"
      IMAGE_NAME: "studentmarkservice-image"
      APP_PORT: "8100"
      NODE_PORT: "30081"
      REPLICA_COUNT: "2"
    steps:
      - checkout

      - run:
          name: Set IMAGE_TAG
          command: |
            echo "export IMAGE_TAG=${CIRCLE_BUILD_NUM}${CIRCLE_BUILD_NUM}" >> $BASH_ENV
            source $BASH_ENV
            echo "Using image tag: ${IMAGE_TAG}"

      - setup_remote_docker:
          docker_layer_caching: true

      - run:
          name: Build Docker image
          command: |
            docker build -t ${IMAGE_NAME}:${IMAGE_TAG} -f Dockerfile .

      - run:
          name: Save Docker image as artifact (optional)
          command: |
            mkdir -p workspace
            docker save -o workspace/${IMAGE_NAME}_${IMAGE_TAG}.tar ${IMAGE_NAME}:${IMAGE_TAG}

      - run:
          name: Deploy to Kubernetes
          command: |
            sudo apt-get update && sudo apt-get install -y gettext-base kubectl

            echo "Kubernetes deployment starting..."

            export KUBECONFIG=$HOME/.kube/config

            envsubst < k8s/namespace-template.yaml > k8s/namespace.yaml
            envsubst < k8s/deployment-template.yaml > k8s/deployment.yaml
            envsubst < k8s/service-template.yaml > k8s/service.yaml

            kubectl apply -f k8s/namespace.yaml --validate=false
            kubectl apply -f k8s/deployment.yaml --validate=false
            kubectl apply -f k8s/service.yaml --validate=false

      - run:
          name: Success Message
          command: echo "âœ… Checkout, Build, Dockerize & Deploy completed successfully!"

workflows:
  version: 2
  build_and_deploy_workflow:
    jobs:
      - build-and-deploy
